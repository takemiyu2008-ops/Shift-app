# 🔐 シフト管理アプリ 認証機能導入手順（従業員番号対応版）

## 📦 提供ファイル

1. **index.html** - 認証機能付きHTMLファイル（従業員番号対応）
2. **app.js** - 認証処理を追加したJavaScriptファイル
3. **styles.css** - スタイルファイル（変更なし）
4. **firebase_rules.json** - Firebaseセキュリティルール

---

## 🎯 ログイン方法

### 従業員が使う情報

```
従業員番号: 3桁の数字（例: 001, 002, 123）
パスワード: 4桁の数字（例: 1234, 5678）
```

### 内部の仕組み

- 従業員番号 `001` → 自動的に `001@staff.local` に変換
- パスワード `1234` → 自動的に `1234pw` に変換（Firebase要件）

**従業員は3桁+4桁だけ覚えればOKです！**

---

## 🚀 導入手順

### ステップ1: ファイルを置き換える

**重要：必ず既存のファイルをバックアップしてください！**

```
既存のファイル → バックアップ → 新しいファイルで置き換え

index.html → 新しい index.html
app.js → 新しい app.js
styles.css → そのまま（変更なし）
```

### ステップ2: Firebaseセキュリティルールを更新

1. **Firebase Console**を開く（https://console.firebase.google.com/）
2. あなたのプロジェクト「shift-app-956a0」を選択
3. 左メニューから **Realtime Database** をクリック
4. 上部の **「ルール」** タブをクリック
5. `firebase_rules.json`の内容を**すべてコピー**
6. ルールエディタに**貼り付け**
7. 右上の **「公開」** ボタンをクリック

### ステップ3: 動作確認

1. アプリのURLにアクセス
2. **ログイン画面**が表示される
3. 「新規登録」をクリック
4. テストアカウントを作成：
   - 名前: テスト太郎
   - 従業員番号: 999
   - パスワード: 9999
5. 「新規登録」ボタンをクリック
6. シフト表が表示されることを確認
7. 右上に **ログアウトボタン** があることを確認
8. ログアウト → 再度ログイン（999 / 9999）できることを確認

---

## 👥 従業員への案内方法

### 従業員に送るメッセージ例

```
【シフトアプリ ログイン方法のご案内】

シフト管理アプリにログイン機能が追加されました。
初回は「新規登録」からアカウントを作成してください。

■ログイン情報
従業員番号: あなたの3桁の番号（例: 001）
パスワード: 好きな4桁の数字（例: 1234）

■初回登録の手順
1. アプリのURLにアクセス
2. 「新規登録」をクリック
3. 名前・従業員番号・パスワードを入力
4. 「新規登録」ボタンをクリック

※パスワードは忘れないようメモしてください
※パスワードを忘れた場合は管理者に連絡してください

アプリURL: [あなたのアプリのURL]
```

---

## 🔧 管理者設定（オプション）

特定のユーザーを管理者にする場合：

### 手順

1. **Firebase Console** → **Realtime Database** → **データ** タブ
2. 最上部の「+」ボタンをクリック
3. 以下を入力：
   - 名前: `admins`
   - 値: （空欄）
4. 「追加」をクリック
5. `admins` ノードを展開
6. 「+」ボタンをクリック
7. 管理者のUIDを追加（下記参照）

### 管理者のUIDを確認する方法

1. **Firebase Console** → **Authentication** → **Users** タブ
2. 該当する従業員を探す（メールアドレスで検索: `001@staff.local` など）
3. ユーザーの行をクリック
4. 「ユーザー UID」の横にある **コピーアイコン** をクリック
5. コピーしたUIDをデータベースの `admins` に追加

例：
```
admins/
  ├─ abc123xyz456: true
  └─ def789uvw012: true
```

---

## 📱 従業員番号の割り当て方

### 推奨方法

```
001 - 店長
002 - 副店長
003 - 田中 太郎
004 - 鈴木 花子
005 - 佐藤 次郎
...
030 - 山田 一郎
```

### ポイント

- ✅ 001から順番に割り当て
- ✅ 数字は3桁（001, 002, ..., 030）
- ✅ 退職者の番号は再利用しない（混乱防止）
- ✅ 新人は次の番号を割り当て

---

## ❓ よくある質問

### Q1: 従業員がパスワードを忘れた

**A:** あなた（管理者）が対応できます。

**方法1: 新しいパスワードを設定して伝える**
1. Firebase Console → Authentication → Users
2. 該当ユーザーを探す（`001@staff.local` など）
3. 右側の「⋮」メニュー → 「パスワードをリセット」
4. 新しいパスワードを入力（例: 5678）
   - ⚠️ 従業員には「5678」と伝えてください（内部で「5678pw」に変換されます）

**方法2: アカウントを削除して再作成してもらう**
1. Firebase Console → Authentication → Users
2. 該当ユーザーを削除
3. 従業員に再度「新規登録」してもらう

### Q2: 「この従業員番号は既に使用されています」エラー

**A:** その番号は既に誰かが使っています。

対処法：
- 別の従業員番号を割り当てる
- または、Firebase Consoleで既存のユーザーを削除

### Q3: ログイン画面が表示されない

**A:** ブラウザのキャッシュが原因かもしれません。

対処法：
1. ブラウザで **Ctrl + Shift + R**（Mac: Cmd + Shift + R）
2. または、シークレットモードで開く

### Q4: 従業員番号を変更したい

**A:** 変更できません。新しいアカウントを作成してください。

理由：
- 従業員番号はアカウントIDの一部なので変更不可
- 新しい番号で再登録してもらってください

### Q5: データが表示されない

**A:** Firebaseルールが正しく設定されているか確認してください。

確認方法：
1. Firebase Console → Realtime Database → ルール
2. `"auth != null"` が含まれているか確認
3. 含まれていれば、ログインしているか確認

---

## 🆘 トラブルシューティング

### エラー: "auth is not defined"

**原因:** Firebase Auth SDKが読み込まれていない

**対処法:**
1. index.htmlを確認
2. `firebase-auth-compat.js` の行があるか確認
3. なければ、提供したファイルで置き換え

### エラー: "メール/パスワード認証が有効になっていません"

**原因:** Firebase Authenticationが有効化されていない

**対処法:**
1. Firebase Console → Authentication
2. 「始める」をクリック
3. 「メール/パスワード」を有効化

### ログインできない（従業員番号とパスワードは正しい）

**確認項目:**
- 従業員番号は3桁ですか？（001, 010, 100）
- パスワードは4桁ですか？
- スペースが入っていませんか？
- 全角数字になっていませんか？（半角で入力）

---

## 📊 利用状況の確認

### 登録ユーザー数を確認

1. Firebase Console → Authentication → Users
2. 「ユーザー」の数を確認

### アクティブユーザーを確認

1. Firebase Console → Authentication → Users
2. 「最終ログイン」列で最近の利用状況を確認

---

## 🔒 セキュリティについて

### 現在のセキュリティレベル

- ✅ ログインしないとデータを見れない
- ✅ 各ユーザーは認証が必要
- ⚠️ 4桁パスワードは推測されやすい可能性

### セキュリティを強化する方法（オプション）

**パスワードを6桁にする場合:**
1. `auth_code_staffid.js` の `convertPassword` 関数を削除
2. 従業員に6桁のパスワードを設定してもらう

---

## 📞 サポート

問題が解決しない場合は、以下の情報を添えて相談してください：

1. 発生している問題の詳細
2. エラーメッセージ（あれば）
3. ブラウザのコンソールログ
   - ブラウザで **F12キー** を押す
   - 「Console」タブを開く
   - スクリーンショットを撮る
4. Firebase Consoleのスクリーンショット

---

## ✅ チェックリスト

導入が完了したら、以下を確認してください：

- [ ] ファイルを置き換えた
- [ ] Firebaseルールを公開した
- [ ] テストアカウントでログインできた
- [ ] シフト表が表示された
- [ ] ログアウトできた
- [ ] 従業員に案内を送った
- [ ] 管理者を設定した（オプション）

---

**🎉 お疲れさまでした！これで認証機能の導入は完了です。**
