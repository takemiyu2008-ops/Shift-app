<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ガントチャート形式のシフト管理アプリ - シフトの追加・編集・申請が簡単に行えます">
    <title>シフト管理アプリ</title>
    <link rel="stylesheet" href="styles.css" charset="UTF-8">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <!-- html2pdf.js for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* ログイン画面のスタイル */
        .auth-container {
            display: none;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
        }
        
        .auth-container.show {
            display: flex;
        }
        
        .auth-box {
            background: white;
            border-radius: 12px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }
        
        .auth-title {
            font-size: 28px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
            color: #1a202c;
        }
        
        .auth-subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .auth-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .auth-label {
            font-size: 14px;
            font-weight: 500;
            color: #4a5568;
        }
        
        .auth-input {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }
        
        .auth-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .auth-hint {
            font-size: 12px;
            color: #718096;
            margin-top: 4px;
        }
        
        .auth-button {
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .auth-button:active {
            transform: translateY(0);
        }
        
        .auth-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .auth-toggle {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: #718096;
        }
        
        .auth-toggle-link {
            color: #667eea;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
        }
        
        .auth-toggle-link:hover {
            text-decoration: underline;
        }
        
        .auth-error {
            background: #fed7d7;
            color: #c53030;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            display: none;
        }
        
        .auth-error.show {
            display: block;
        }
        
        .app-container.hidden {
            display: none !important;
        }
        
        .logout-btn-container {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        
        .logout-btn {
            padding: 8px 16px;
            font-size: 14px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .logout-btn:hover {
            background: #dc2626;
        }

        /* 承認待ち画面 */
        .pending-container {
            display: none;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
        }

        .pending-container.show {
            display: flex;
        }

        .pending-box {
            background: white;
            border-radius: 12px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .pending-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .pending-title {
            font-size: 22px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 12px;
        }

        .pending-message {
            color: #718096;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .pending-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 24px;
        }

        .pending-dots span {
            width: 10px;
            height: 10px;
            background: #667eea;
            border-radius: 50%;
            animation: pendingBounce 1.4s infinite ease-in-out both;
        }

        .pending-dots span:nth-child(1) { animation-delay: -0.32s; }
        .pending-dots span:nth-child(2) { animation-delay: -0.16s; }
        .pending-dots span:nth-child(3) { animation-delay: 0s; }

        @keyframes pendingBounce {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
            40% { transform: scale(1); opacity: 1; }
        }

        .pending-logout-btn {
            padding: 10px 24px;
            background: #e2e8f0;
            color: #4a5568;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .pending-logout-btn:hover {
            background: #cbd5e0;
        }

        /* 却下時スタイル */
        .pending-box.rejected .pending-icon { display: none; }
        .pending-box.rejected .pending-dots { display: none; }
        .rejected-icon { display: none; font-size: 64px; margin-bottom: 20px; }
        .pending-box.rejected .rejected-icon { display: block; }
    </style>

</head>

<body>
    <!-- ログイン画面 -->
    <div class="auth-container show" id="authContainer">
        <div class="auth-box">
            <h1 class="auth-title">📅 シフト管理</h1>
            <p class="auth-subtitle" id="authSubtitle">ログインしてください</p>
            
            <div class="auth-error" id="authError"></div>
            
            <!-- ログインフォーム -->
            <form class="auth-form" id="loginForm">
                <div class="auth-input-group">
                    <label class="auth-label">従業員番号（3桁）</label>
                    <input type="text" class="auth-input staff-id-input" id="loginStaffId" 
                           required placeholder="例: 001" maxlength="3" inputmode="numeric" pattern="[0-9]{3}">
                    <p class="auth-hint">あなたの3桁の従業員番号を入力してください</p>
                </div>
                <div class="auth-input-group">
                    <label class="auth-label">パスワード（4桁の数字）</label>
                    <input type="password" class="auth-input password-input" id="loginPassword" 
                           required placeholder="例: 1234" maxlength="4" inputmode="numeric" pattern="[0-9]{4}">
                    <p class="auth-hint">4桁の数字を入力してください</p>
                </div>
                <button type="submit" class="auth-button">ログイン</button>
            </form>
            
            <!-- 新規登録フォーム -->
            <form class="auth-form" id="registerForm" style="display: none;">
                <div class="auth-input-group">
                    <label class="auth-label">名前</label>
                    <input type="text" class="auth-input" id="registerName" required 
                           placeholder="例: 山田 太郎" autocomplete="name">
                    <p class="auth-hint">あなたの名前をフルネームで入力してください</p>
                </div>
                <div class="auth-input-group">
                    <label class="auth-label">従業員番号（3桁）</label>
                    <input type="text" class="auth-input staff-id-input" id="registerStaffId" 
                           required placeholder="例: 001" maxlength="3" inputmode="numeric" pattern="[0-9]{3}">
                    <p class="auth-hint">あなたの3桁の従業員番号を入力してください</p>
                </div>
                <div class="auth-input-group">
                    <label class="auth-label">パスワード（4桁の数字）</label>
                    <input type="password" class="auth-input password-input" id="registerPassword" 
                           required placeholder="例: 1234" maxlength="4" inputmode="numeric" pattern="[0-9]{4}">
                    <p class="auth-hint">覚えやすい4桁の数字を設定してください</p>
                </div>
                <button type="submit" class="auth-button">新規登録</button>
            </form>
            
            <div class="auth-toggle">
                <span id="toggleText">まだ登録していない方は</span>
                <a class="auth-toggle-link" id="toggleAuthMode">新規登録</a>
            </div>
        </div>
    </div>

    <!-- 承認待ち画面 -->
    <div class="pending-container" id="pendingContainer">
        <div class="pending-box" id="pendingBox">
            <div class="pending-icon">⏳</div>
            <div class="rejected-icon">❌</div>
            <h2 class="pending-title" id="pendingTitle">承認待ち</h2>
            <p class="pending-message" id="pendingMessage">
                アカウント登録が完了しました。<br>
                管理者の承認をお待ちください。<br>
                承認されると自動的にアプリが利用可能になります。
            </p>
            <div class="pending-dots">
                <span></span><span></span><span></span>
            </div>
            <button class="pending-logout-btn" onclick="auth.signOut()">ログアウト</button>
        </div>
    </div>

    <!-- ログアウトボタン -->
    <div class="logout-btn-container" id="logoutBtnContainer" style="display: none;">
        <button id="logoutBtn" class="logout-btn">
            🚪 ログアウト
        </button>
    </div>


    <div class="app-container hidden" id="appContainer">
        <!-- 接続状態表示 -->
        <div class="connection-status" id="connectionStatus">
            <span class="status-dot"></span>
            <span class="status-text">接続中...</span>
        </div>

        <!-- ヘッダー -->
        <header class="header">
            <h1 class="header-title">
                <span class="header-icon">📅</span>
                シフト管理
            </h1>
            <div class="header-actions">
                <!-- ロール切り替え -->
                <div class="role-toggle">
                    <span class="role-label">モード:</span>
                    <button id="roleToggle" class="role-btn">
                        <span class="role-icon">👤</span>
                        <span id="roleText">スタッフ</span>
                    </button>
                </div>
                <button id="orderAdviceBtn" class="btn btn-info">
                    📦 発注アドバイス
                </button>
                <button id="addShiftBtn" class="btn btn-primary">
                    <span class="btn-icon">+</span>
                    シフト追加
                </button>
                <button id="requestChangeBtn" class="btn btn-secondary">
                    🔄 シフト変更申請
                </button>
                <button id="shiftSwapBtn" class="btn btn-secondary">
                    🤝 シフト交代依頼
                </button>
                <button id="requestLeaveBtn" class="btn btn-secondary">
                    🏖️ 有給申請
                </button>
                <button id="requestHolidayBtn" class="btn btn-secondary">
                    🏠 休日申請
                </button>
            </div>
        </header>

        <!-- モバイル用 発注アドバイスフローティングボタン -->
        <button id="orderAdviceBtnMobile" class="order-advice-fab">
            📦
        </button>

        <!-- 管理者パネル（管理者モード時のみ表示） -->
        <div class="admin-panel" id="adminPanel" style="display: none;">
            <div class="admin-header">
                <h2>📋 管理者メニュー</h2>
                <div class="admin-tabs">
                    <button class="admin-tab" data-tab="userApproval">👤 ユーザー承認</button>
                    <button class="admin-tab active" data-tab="shiftChanges">シフト変更</button>
                    <button class="admin-tab" data-tab="shiftSwaps">シフト交換</button>
                    <button class="admin-tab" data-tab="leaveRequests">有給申請</button>
                    <button class="admin-tab" data-tab="holidayRequests">休日申請</button>
                    <button class="admin-tab" data-tab="specialEvents">⚡ 臨時シフト管理</button>
                    <button class="admin-tab" data-tab="fixedShiftManage">🔁 固定シフト管理</button>
                    <button class="admin-tab" data-tab="dailyEvents">📅 店舗スケジュール</button>
                    <button class="admin-tab" data-tab="nonDailyAdvice">📈 非デイリー参考情報</button>
                    <button class="admin-tab" data-tab="feedbackStats">📊 フィードバック集計</button>
                    <button class="admin-tab" data-tab="productCategories">📂 商品分類管理</button>
                    <button class="admin-tab" data-tab="trendReports">📊 コンビニ3社 新商品ヒット予測レポート</button>
                    <button class="admin-tab" data-tab="newProductReport">🆕 週次インテリジェンス（マクロ環境）</button>
                    <button class="admin-tab" data-tab="usageStats">📈 利用統計</button>
                    <button class="admin-tab" data-tab="history">📜 履歴</button>
                    <button class="admin-tab" data-tab="employees">従業員管理</button>
                    <button class="admin-tab" data-tab="broadcast">全員へ通知</button>
                    <button class="admin-tab" data-tab="settings">設定</button>
                </div>
            </div>
            <div class="admin-content" id="adminContent">
            </div>
        </div>

        <!-- メッセージ通知バー -->
        <div class="message-bar" id="messageBar" style="display: none;">
            <div class="message-bar-content">
                <span class="message-icon">📩</span>
                <span id="messageCount">0</span>件の新しいメッセージ
            </div>
            <button id="viewMessagesBtn" class="btn btn-sm btn-primary">確認</button>
        </div>

        <!-- 発注・スケジュール情報グループ -->
        <div class="advisor-group" id="advisorGroup">
            <div class="advisor-group-header" id="advisorGroupHeader">
                <span class="advisor-group-icon">📋</span>
                <span class="advisor-group-title">発注・スケジュール情報</span>
                <button class="advisor-group-toggle" id="advisorGroupToggle">▼</button>
            </div>
            <div class="advisor-group-content collapsed" id="advisorGroupContent">
                <!-- レポートグループ -->
                <div class="order-advisor reports-group-section" id="reportsGroupSection">
                    <div class="advisor-header" id="reportsGroupHeader">
                        <span class="advisor-icon">📑</span>
                        <span class="advisor-title">レポート</span>
                        <button class="advisor-toggle collapsed" id="reportsGroupToggle">▼</button>
                    </div>
                    <div class="advisor-content collapsed" id="reportsGroupContent">
                        <!-- コンビニ3社 新商品ヒット予測レポート -->
                        <div class="order-advisor trend-report-section sub-report" id="trendReportSection">
                            <div class="advisor-header sub-header">
                                <span class="advisor-icon">📊</span>
                                <span class="advisor-title">コンビニ3社 新商品ヒット予測レポート</span>
                                <button class="advisor-toggle collapsed" id="trendReportToggle">▼</button>
                            </div>
                            <div class="advisor-content collapsed" id="trendReportContent">
                                <!-- JSで動的に生成 -->
                            </div>
                        </div>

                        <!-- 週次インテリジェンス（マクロ環境） -->
                        <div class="order-advisor new-product-report sub-report" id="newProductReportSection">
                            <div class="advisor-header sub-header">
                                <span class="advisor-icon">🆕</span>
                                <span class="advisor-title">週次インテリジェンス（マクロ環境）</span>
                                <button class="advisor-toggle collapsed" id="newProductToggle">▼</button>
                            </div>
                            <div class="advisor-content collapsed" id="newProductContent">
                                <!-- JSで動的に生成 -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 非デイリー発注参考情報 -->
                <div class="order-advisor non-daily-advisor" id="nonDailyAdvisor" style="display: none;">
                    <div class="advisor-header">
                        <span class="advisor-icon">📈</span>
                        <span class="advisor-title">非デイリー発注参考情報（毎週月曜更新）</span>
                        <button class="advisor-toggle collapsed" id="nonDailyToggle">▼</button>
                    </div>
                    <div class="advisor-content collapsed" id="nonDailyContent">
                        <!-- JSで動的に生成 -->
                    </div>
                </div>

                <!-- 店舗スケジュール一覧 -->
                <div class="order-advisor schedule-list-section" id="scheduleListSection" style="display: none;">
                    <div class="advisor-header">
                        <span class="advisor-icon">📅</span>
                        <span class="advisor-title">店舗スケジュール一覧</span>
                        <button class="advisor-toggle collapsed" id="scheduleToggle">▼</button>
                    </div>
                    <div class="advisor-content collapsed" id="scheduleListContent">
                        <!-- JSで動的に生成 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 印刷画面グループ -->
        <div class="advisor-group print-group" id="printGroup">
            <div class="advisor-group-header" id="printGroupHeader">
                <span class="advisor-group-icon">🖨️</span>
                <span class="advisor-group-title">印刷画面（PDF出力、印刷）</span>
                <button class="advisor-group-toggle" id="printGroupToggle">▼</button>
            </div>
            <div class="advisor-group-content collapsed" id="printGroupContent">
                <div class="pdf-section-inner">
                    <button id="exportPdfBtn" class="btn btn-info">
                        📄 PDF出力
                    </button>
                    <button id="printBtn" class="btn btn-secondary">
                        🖨️ 印刷
                    </button>
                </div>
            </div>
        </div>

        <!-- ズームコントロール -->
        <div class="zoom-controls">
            <div class="zoom-section">
                <span class="zoom-label">🔍 表示サイズ:</span>
                <button id="zoomOut" class="zoom-btn">−</button>
                <input type="range" id="zoomSlider" min="50" max="150" value="100" class="zoom-slider">
                <button id="zoomIn" class="zoom-btn">+</button>
                <span id="zoomValue" class="zoom-value">100%</span>
                <button id="zoomReset" class="btn btn-sm btn-secondary">リセット</button>
            </div>
        </div>

        <!-- 日付ナビゲーション -->
        <div class="date-nav">
            <button id="prevWeek" class="nav-btn">
                <span>◀</span>
                前週
            </button>
            <div class="current-period" id="currentPeriod">2026年1月12日 〜 1月18日</div>
            <button id="nextWeek" class="nav-btn">
                次週
                <span>▶</span>
            </button>
        </div>

        <!-- ガントチャート -->
        <div class="gantt-container">
            <div class="gantt-header">
                <div class="gantt-label-header">日付</div>
                <div class="gantt-time-header" id="timeHeader">
                </div>
            </div>
            <div class="gantt-body" id="ganttBody">
            </div>
        </div>

        <!-- 凡例（非表示） -->
        <div class="legend" style="display: none;">
            <div class="legend-title">担当者</div>
            <div class="legend-items" id="legendItems">
            </div>
        </div>
    </div>

    <!-- シフト詳細ポップオーバー -->
    <div class="shift-popover" id="shiftPopover">
        <div class="popover-content">
            <div class="popover-header">
                <span class="popover-title" id="popoverTitle">シフト詳細</span>
                <button class="popover-close" id="popoverClose">×</button>
            </div>
            <div class="popover-body">
                <div class="popover-info">
                    <div class="info-row">
                        <span class="info-label">担当者:</span>
                        <span class="info-value" id="popoverName">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">日付:</span>
                        <span class="info-value" id="popoverDate">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">時間:</span>
                        <span class="info-value" id="popoverTime">-</span>
                    </div>
                    <div class="info-row" id="popoverOvernightRow" style="display: none;">
                        <span class="info-label">タイプ:</span>
                        <span class="info-value overnight-badge">🌙 夜勤</span>
                    </div>
                    <div class="info-row" id="popoverFixedRow" style="display: none;">
                        <span class="info-label">タイプ:</span>
                        <span class="info-value fixed-badge">🔁 固定シフト</span>
                    </div>
                    <div class="info-row" id="popoverChangeRow" style="display: none;">
                        <span class="info-label">変更履歴:</span>
                        <span class="info-value" id="popoverChangeInfo">-</span>
                    </div>
                    <div class="info-row" id="popoverSwapRow" style="display: none;">
                        <span class="info-label">交代履歴:</span>
                        <span class="info-value" id="popoverSwapInfo">-</span>
                    </div>
                    <div class="info-row" id="popoverOverrideRow" style="display: none;">
                        <span class="info-label">単日変更:</span>
                        <span class="info-value override-badge">📝 この日のみ変更済み</span>
                    </div>
                </div>
            </div>
            <div class="popover-actions">
                <div class="popover-action-row">
                    <button class="btn btn-primary btn-sm" id="popoverEditBtn">✏️ 編集</button>
                    <button class="btn btn-secondary btn-sm" id="popoverOverrideBtn" style="display: none;">📝 この日のみ</button>
                    <button class="btn btn-danger btn-sm" id="popoverDeleteBtn">🗑️ 削除</button>
                </div>
                <div class="popover-action-row">
                    <button class="btn btn-sm" id="popoverTaskBtn" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;flex:1;">📋 業務内容</button>
                </div>
                <div class="popover-action-row">
                    <button class="btn btn-info btn-sm" id="popoverMorningHalfDayBtn">🌅 午前半休</button>
                    <button class="btn btn-info btn-sm" id="popoverAfternoonHalfDayBtn">🌇 午後半休</button>
                    <button class="btn btn-warning btn-sm" id="popoverDayOffBtn">🏠 休み</button>
                </div>
            </div>
        </div>
    </div>

    <!-- シフト追加モーダル -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="shiftModalTitle">シフト追加</h2>
                <button class="modal-close" id="modalClose">×</button>
            </div>
            <form id="shiftForm" class="modal-body">
                <input type="hidden" id="editShiftId" value="">
                <div class="form-group">
                    <label for="shiftDate">日付</label>
                    <input type="date" id="shiftDate" required>
                    <p class="form-hint" id="shiftDateDay"></p>
                </div>
                <div class="form-group">
                    <label for="shiftName">氏名</label>
                    <select id="shiftName" required>
                        <option value="">選択してください</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="shiftStart">開始時刻</label>
                        <select id="shiftStart" required></select>
                    </div>
                    <div class="form-group">
                        <label for="shiftEnd">終了時刻</label>
                        <select id="shiftEnd" required></select>
                    </div>
                </div>
                <div class="form-group overnight-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="overnightShift">
                        <span class="checkbox-text">🌙 夜勤（翌日に跨ぐ）</span>
                    </label>
                    <p class="form-hint">例：22:00〜翌9:00のシフト</p>
                </div>
                <div class="form-group">
                    <label for="shiftColor">色</label>
                    <div class="color-picker" id="colorPicker">
                        <button type="button" class="color-option" data-color="#6366f1"
                            style="background: #6366f1;"></button>
                        <button type="button" class="color-option" data-color="#8b5cf6"
                            style="background: #8b5cf6;"></button>
                        <button type="button" class="color-option" data-color="#ec4899"
                            style="background: #ec4899;"></button>
                        <button type="button" class="color-option" data-color="#14b8a6"
                            style="background: #14b8a6;"></button>
                        <button type="button" class="color-option" data-color="#f59e0b"
                            style="background: #f59e0b;"></button>
                        <button type="button" class="color-option" data-color="#10b981"
                            style="background: #10b981;"></button>
                    </div>
                    <input type="hidden" id="shiftColor" value="#6366f1">
                </div>
                <div class="form-group fixed-shift-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="fixedShift">
                        <span class="checkbox-text">🔁 固定シフト（毎週繰り返し）</span>
                    </label>
                    <p class="form-hint">チェックすると、毎週同じ曜日・時間にシフトが自動表示されます</p>
                    <div id="fixedShiftPeriod" class="fixed-shift-period" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fixedStartDate">開始日</label>
                                <input type="date" id="fixedStartDate">
                                <p class="form-hint">指定した日から有効</p>
                            </div>
                            <div class="form-group">
                                <label for="fixedEndDate">終了日</label>
                                <input type="date" id="fixedEndDate">
                                <label class="checkbox-label" style="margin-top: 4px;">
                                    <input type="checkbox" id="fixedNoEndDate" checked>
                                    <span class="checkbox-text">終了日なし（無期限）</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">キャンセル</button>
                    <button type="submit" class="btn btn-primary" id="shiftSubmitBtn">追加</button>
                </div>
            </form>
        </div>
    </div>

    <!-- シフト変更申請モーダル -->
    <div class="modal-overlay" id="changeModalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">🔄 シフト変更申請</h2>
                <button class="modal-close" id="changeModalClose">×</button>
            </div>
            <form id="changeForm" class="modal-body">
                <div class="form-group">
                    <label for="changeApplicant">申請者名</label>
                    <select id="changeApplicant" required></select>
                </div>
                <div class="form-group">
                    <label for="changeShiftSelect">変更するシフト</label>
                    <select id="changeShiftSelect" required></select>
                </div>
                <div class="form-group">
                    <label for="changeDate">新しい日付</label>
                    <input type="date" id="changeDate" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="changeStart">新しい開始時刻</label>
                        <select id="changeStart" required></select>
                    </div>
                    <div class="form-group">
                        <label for="changeEnd">新しい終了時刻</label>
                        <select id="changeEnd" required></select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="changeReason">変更理由</label>
                    <textarea id="changeReason" placeholder="例：私用のため" rows="3" required></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="changeCancelBtn">キャンセル</button>
                    <button type="submit" class="btn btn-primary">申請</button>
                </div>
            </form>
        </div>
    </div>

    <!-- シフト交代依頼モーダル -->
    <div class="modal-overlay" id="swapModalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">🤝 シフト交代依頼</h2>
                <button class="modal-close" id="swapModalClose">×</button>
            </div>
            <form id="swapForm" class="modal-body">
                <div class="form-group">
                    <label for="swapApplicant">申請者名</label>
                    <select id="swapApplicant" required></select>
                </div>
                <div class="form-group">
                    <label for="swapShiftSelect">交代してほしいシフト</label>
                    <select id="swapShiftSelect" required></select>
                </div>
                <div class="form-group">
                    <label for="swapTargetEmployee">依頼する相手</label>
                    <select id="swapTargetEmployee" required></select>
                </div>
                <div class="form-group">
                    <label for="swapMessage">メッセージ</label>
                    <textarea id="swapMessage" placeholder="例：急用ができてしまいました。シフトを変わっていただけませんか？" rows="3"
                        required></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="swapCancelBtn">キャンセル</button>
                    <button type="submit" class="btn btn-primary">依頼を送る</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 有給申請モーダル -->
    <div class="modal-overlay" id="leaveModalOverlay">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h2 class="modal-title">🏖️ 有給申請</h2>
                <button class="modal-close" id="leaveModalClose">×</button>
            </div>
            <form id="leaveForm" class="modal-body">
                <div class="form-group">
                    <label for="leaveName">申請者名</label>
                    <select id="leaveName" required onchange="updateLeaveShiftList()"></select>
                </div>
                <div class="form-group">
                    <label>取得したいシフトを選択（複数選択可）</label>
                    <p class="form-hint">有給を取得したいシフトにチェックを入れてください</p>
                    <div class="shift-selection-list" id="leaveShiftList">
                        <p class="no-shift-message">申請者を選択してください</p>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="leaveCancelBtn">キャンセル</button>
                    <button type="submit" class="btn btn-primary">申請</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 休日申請モーダル -->
    <div class="modal-overlay" id="holidayModalOverlay">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h2 class="modal-title">🏠 休日申請</h2>
                <button class="modal-close" id="holidayModalClose">×</button>
            </div>
            <form id="holidayForm" class="modal-body">
                <div class="form-group">
                    <label for="holidayName">申請者名</label>
                    <select id="holidayName" required onchange="updateHolidayShiftList()"></select>
                </div>
                <div class="form-group">
                    <label>休みを申請したいシフトを選択</label>
                    <p class="form-hint">休日を申請したいシフトにチェックを入れてください</p>
                    <div class="shift-selection-list" id="holidayShiftList">
                        <p class="no-shift-message">申請者を選択してください</p>
                    </div>
                </div>
                <div class="form-group" id="holidayTimeRangeGroup" style="display: none;">
                    <label>休みの時間帯（任意）</label>
                    <p class="form-hint">特定の時間帯のみ休む場合は指定してください（指定しない場合は全日休み）</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="holidayStartTime">開始時刻</label>
                            <select id="holidayStartTime">
                                <option value="">シフト開始時刻</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="holidayEndTime">終了時刻</label>
                            <select id="holidayEndTime">
                                <option value="">シフト終了時刻</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>シフト交代依頼していますか？</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="holidaySwapRequested" value="no" checked>
                            <span>いいえ</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="holidaySwapRequested" value="yes">
                            <span>はい</span>
                        </label>
                    </div>
                </div>
                <div class="form-group" id="holidaySwapPartnerGroup" style="display: none;">
                    <label for="holidaySwapPartner">シフト交代している場合は、誰としていますか？</label>
                    <select id="holidaySwapPartner"></select>
                </div>
                <div class="form-group">
                    <label for="holidayReason">申請理由</label>
                    <textarea id="holidayReason" placeholder="例：家族との予定のため" rows="3" required></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="holidayCancelBtn">キャンセル</button>
                    <button type="submit" class="btn btn-primary">申請</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 暗証番号入力モーダル -->
    <div class="modal-overlay" id="pinModalOverlay">
        <div class="modal modal-sm">
            <div class="modal-header">
                <h2 class="modal-title">🔐 管理者認証</h2>
                <button class="modal-close" id="pinModalClose">×</button>
            </div>
            <form id="pinForm" class="modal-body">
                <div class="form-group">
                    <label for="adminPin">暗証番号（4桁）</label>
                    <input type="password" id="adminPin" placeholder="••••" maxlength="4" pattern="[0-9]{4}"
                        inputmode="numeric" required>
                </div>
                <p id="pinError" class="error-text" style="display: none;">暗証番号が間違っています</p>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="pinCancelBtn">キャンセル</button>
                    <button type="submit" class="btn btn-primary">認証</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 暗証番号変更モーダル -->
    <div class="modal-overlay" id="changePinModalOverlay">
        <div class="modal modal-sm">
            <div class="modal-header">
                <h2 class="modal-title">🔑 暗証番号変更</h2>
                <button class="modal-close" id="changePinModalClose">×</button>
            </div>
            <form id="changePinForm" class="modal-body">
                <div class="form-group">
                    <label for="currentPin">現在の暗証番号</label>
                    <input type="password" id="currentPin" placeholder="••••" maxlength="4" pattern="[0-9]{4}"
                        inputmode="numeric" required>
                </div>
                <div class="form-group">
                    <label for="newPin">新しい暗証番号</label>
                    <input type="password" id="newPin" placeholder="••••" maxlength="4" pattern="[0-9]{4}"
                        inputmode="numeric" required>
                </div>
                <div class="form-group">
                    <label for="confirmPin">新しい暗証番号（確認）</label>
                    <input type="password" id="confirmPin" placeholder="••••" maxlength="4" pattern="[0-9]{4}"
                        inputmode="numeric" required>
                </div>
                <p id="changePinError" class="error-text" style="display: none;"></p>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="changePinCancelBtn">キャンセル</button>
                    <button type="submit" class="btn btn-primary">変更</button>
                </div>
            </form>
        </div>
    </div>

    <!-- メッセージ一覧モーダル -->
    <div class="modal-overlay" id="messagesModalOverlay">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h2 class="modal-title">📩 メッセージ</h2>
                <button class="modal-close" id="messagesModalClose">×</button>
            </div>
            <div class="modal-body" id="messagesContent">
            </div>
        </div>
    </div>

    <!-- 従業員追加/編集モーダル -->
    <div class="modal-overlay" id="employeeModalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="employeeModalTitle">👤 従業員追加</h2>
                <button class="modal-close" id="employeeModalClose">×</button>
            </div>
            <form id="employeeForm" class="modal-body">
                <input type="hidden" id="editEmployeeId" value="">
                <div class="form-group">
                    <label for="employeeName">名前</label>
                    <input type="text" id="employeeName" placeholder="例：田中太郎" required>
                </div>
                <div class="form-group">
                    <label for="employeeRole">役職</label>
                    <select id="employeeRole" required>
                        <option value="staff">スタッフ</option>
                        <option value="shiftLeader">シフトリーダー</option>
                        <option value="employee">社員</option>
                        <option value="manager">マネージャー</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="employeeShiftTime">シフト時間帯</label>
                    <select id="employeeShiftTime" required>
                        <option value="day">日勤</option>
                        <option value="evening">夕勤</option>
                        <option value="night">夜勤</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>発注担当分類（複数選択可）</label>
                    <div class="order-categories" id="orderCategories">
                        <label class="category-checkbox">
                            <input type="checkbox" name="orderCategory" value="米飯">
                            <span>米飯</span>
                        </label>
                        <label class="category-checkbox">
                            <input type="checkbox" name="orderCategory" value="調理パン">
                            <span>調理パン</span>
                        </label>
                        <label class="category-checkbox">
                            <input type="checkbox" name="orderCategory" value="麺類その他">
                            <span>麺類その他</span>
                        </label>
                        <label class="category-checkbox">
                            <input type="checkbox" name="orderCategory" value="デザート">
                            <span>デザート</span>
                        </label>
                        <label class="category-checkbox">
                            <input type="checkbox" name="orderCategory" value="デリカテッセン（サラダ、惣菜）">
                            <span>デリカテッセン（サラダ、惣菜）</span>
                        </label>
                        <label class="category-checkbox">
                            <input type="checkbox" name="orderCategory" value="７Pデリカ">
                            <span>７Pデリカ</span>
                        </label>
                        <label class="category-checkbox">
                            <input type="checkbox" name="orderCategory" value="デリテッセン（その他）">
                            <span>デリテッセン（その他）</span>
                        </label>
                        <label class="category-checkbox">
                            <input type="checkbox" name="orderCategory" value="牛乳乳飲料">
                            <span>牛乳乳飲料</span>
                        </label>
                        <label class="category-checkbox">
                            <input type="checkbox" name="orderCategory" value="FF（おでん、中華まん）">
                            <span>FF（おでん、中華まん）</span>
                        </label>
                        <label class="category-checkbox">
                            <input type="checkbox" name="orderCategory" value="お菓子（チョコレート、和菓子類）">
                            <span>お菓子（チョコレート、和菓子類）</span>
                        </label>
                        <label class="category-checkbox">
                            <input type="checkbox" name="orderCategory" value="お菓子（グミ、駄菓子、飴類）">
                            <span>お菓子（グミ、駄菓子、飴類）</span>
                        </label>
                        <label class="category-checkbox">
                            <input type="checkbox" name="orderCategory" value="お菓子（ポテトチップス、箱スナック、米菓）">
                            <span>お菓子（ポテトチップス、箱スナック、米菓）</span>
                        </label>
                        <label class="category-checkbox">
                            <input type="checkbox" name="orderCategory" value="雑貨類">
                            <span>雑貨類</span>
                        </label>
                        <label class="category-checkbox">
                            <input type="checkbox" name="orderCategory" value="消耗品">
                            <span>消耗品</span>
                        </label>
                        <label class="category-checkbox">
                            <input type="checkbox" name="orderCategory" value="加工食品（調味料類、珍味）">
                            <span>加工食品（調味料類、珍味）</span>
                        </label>
                        <label class="category-checkbox">
                            <input type="checkbox" name="orderCategory" value="ドリンク類">
                            <span>ドリンク類</span>
                        </label>
                        <label class="category-checkbox">
                            <input type="checkbox" name="orderCategory" value="フローズン（アイス、冷凍食品）">
                            <span>フローズン（アイス、冷凍食品）</span>
                        </label>
                        <label class="category-checkbox">
                            <input type="checkbox" name="orderCategory" value="フローズン（フライヤー、焼成パン）">
                            <span>フローズン（フライヤー、焼成パン）</span>
                        </label>
                        <label class="category-checkbox">
                            <input type="checkbox" name="orderCategory" value="タバコ">
                            <span>タバコ</span>
                        </label>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="employeeCancelBtn">キャンセル</button>
                    <button type="submit" class="btn btn-primary" id="employeeSubmitBtn">追加</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 臨時シフト（特別イベント）モーダル -->
    <div class="modal-overlay" id="specialEventModalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="specialEventModalTitle">⚡ イベント日を追加</h2>
                <button class="modal-close" id="specialEventModalClose">×</button>
            </div>
            <form id="specialEventForm" class="modal-body">
                <input type="hidden" id="editSpecialEventId" value="">
                <div class="form-group">
                    <label for="specialEventDate">イベント日</label>
                    <input type="date" id="specialEventDate" required>
                </div>
                <div class="form-group">
                    <label for="specialEventName">イベント名</label>
                    <input type="text" id="specialEventName" placeholder="例：棚卸し、店舗改装、特別セール" required>
                </div>
                <div class="form-group">
                    <label for="specialEventDescription">説明（任意）</label>
                    <textarea id="specialEventDescription" rows="2" placeholder="イベントの詳細やメモ" style="width:100%;background:#1e293b;color:#f8fafc;border:1px solid #334155;border-radius:6px;padding:8px;font-size:0.9rem;resize:vertical;"></textarea>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="suppressFixedShifts" checked>
                        <span class="checkbox-text">🚫 この日の固定シフトを停止する</span>
                    </label>
                    <p class="form-hint">チェックすると、固定シフトが非表示になり、手動で追加したシフトのみが表示されます</p>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="specialEventCancelBtn">キャンセル</button>
                    <button type="submit" class="btn btn-primary" id="specialEventSubmitBtn">追加</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 全員へ通知モーダル -->
    <div class="modal-overlay" id="broadcastModalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">📢 全員へ通知</h2>
                <button class="modal-close" id="broadcastModalClose">×</button>
            </div>
            <form id="broadcastForm" class="modal-body">
                <div class="form-group">
                    <label for="broadcastTitle">件名</label>
                    <input type="text" id="broadcastTitle" placeholder="例：来週のシフトについて" required>
                </div>
                <div class="form-group">
                    <label for="broadcastMessage">メッセージ</label>
                    <textarea id="broadcastMessage" placeholder="全従業員に送信するメッセージを入力してください" rows="5" required></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="broadcastCancelBtn">キャンセル</button>
                    <button type="submit" class="btn btn-primary">送信</button>
                </div>
            </form>
        </div>
    </div>

    <!-- イベント追加/編集モーダル -->
    <div class="modal-overlay" id="eventModalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="eventModalTitle">📅 イベント追加</h2>
                <button class="modal-close" id="eventModalClose">×</button>
            </div>
            <form id="eventForm" class="modal-body">
                <input type="hidden" id="editEventId" value="">
                <div class="form-row">
                    <div class="form-group">
                        <label for="eventStartDate">開始日</label>
                        <input type="date" id="eventStartDate" required>
                    </div>
                    <div class="form-group">
                        <label for="eventEndDate">終了日</label>
                        <input type="date" id="eventEndDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="eventType">タイプ</label>
                    <select id="eventType" required>
                        <option value="sale">🏷️ セール</option>
                        <option value="notice">📢 連絡事項</option>
                        <option value="training">📚 研修</option>
                        <option value="inventory">📦 棚卸</option>
                        <option value="delivery">🚚 特発納品</option>
                        <option value="other">📌 その他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="eventTitle">タイトル</label>
                    <input type="text" id="eventTitle" placeholder="例：タイムセール" required>
                </div>
                <div class="form-group">
                    <label for="eventDescription">詳細</label>
                    <textarea id="eventDescription" placeholder="例：16:00〜18:00 全品10%OFF" rows="3"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="eventCancelBtn">キャンセル</button>
                    <button type="submit" class="btn btn-primary" id="eventSubmitBtn">追加</button>
                </div>
            </form>
        </div>
    </div>

    <!-- イベント詳細ポップオーバー -->
    <div class="event-popover" id="eventPopover">
        <div class="popover-content">
            <div class="popover-header">
                <span class="popover-title" id="eventPopoverTitle">イベント詳細</span>
                <button class="popover-close" id="eventPopoverClose">×</button>
            </div>
            <div class="popover-body" id="eventPopoverBody">
            </div>
        </div>
    </div>

    <!-- 業務内容（タスク）管理モーダル -->
    <div class="modal-overlay" id="taskModalOverlay">
        <div class="modal" style="max-width:520px;">
            <div class="modal-header">
                <h2 class="modal-title" id="taskModalTitle">📋 業務内容を管理</h2>
                <button class="modal-close" id="taskModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <div id="taskShiftInfo" style="background:var(--bg-tertiary);padding:12px 14px;border-radius:8px;margin-bottom:14px;">
                    <div style="font-weight:600;font-size:0.95rem;" id="taskShiftInfoText"></div>
                </div>
                <div id="taskList" style="margin-bottom:16px;"></div>
                <div style="border:1px solid var(--border);border-radius:8px;padding:16px;background:var(--bg-secondary);">
                    <h3 style="font-size:0.9rem;font-weight:600;margin-bottom:12px;margin-top:0;color:var(--text-secondary);">➕ 業務を追加</h3>
                    <div class="form-group" style="margin-bottom:10px;">
                        <label for="taskName" style="font-size:0.85rem;">業務名</label>
                        <input type="text" id="taskName" placeholder="例：シフトフォロー、商品展示会" style="width:100%;padding:8px 12px;background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;font-size:0.9rem;box-sizing:border-box;">
                    </div>
                    <div class="form-row" style="gap:10px;margin-bottom:10px;">
                        <div class="form-group" style="flex:1;">
                            <label for="taskStartHour" style="font-size:0.85rem;">開始</label>
                            <select id="taskStartHour" style="width:100%;padding:8px;background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;font-size:0.9rem;"></select>
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label for="taskEndHour" style="font-size:0.85rem;">終了</label>
                            <select id="taskEndHour" style="width:100%;padding:8px;background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;font-size:0.9rem;"></select>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom:12px;">
                        <label style="font-size:0.85rem;">業務カラー</label>
                        <div id="taskColorPicker" style="display:flex;gap:6px;flex-wrap:wrap;margin-top:4px;">
                            <button type="button" class="task-color-option selected" data-color="#10b981" style="width:28px;height:28px;border-radius:50%;border:2px solid transparent;background:#10b981;cursor:pointer;"></button>
                            <button type="button" class="task-color-option" data-color="#f59e0b" style="width:28px;height:28px;border-radius:50%;border:2px solid transparent;background:#f59e0b;cursor:pointer;"></button>
                            <button type="button" class="task-color-option" data-color="#ef4444" style="width:28px;height:28px;border-radius:50%;border:2px solid transparent;background:#ef4444;cursor:pointer;"></button>
                            <button type="button" class="task-color-option" data-color="#3b82f6" style="width:28px;height:28px;border-radius:50%;border:2px solid transparent;background:#3b82f6;cursor:pointer;"></button>
                            <button type="button" class="task-color-option" data-color="#8b5cf6" style="width:28px;height:28px;border-radius:50%;border:2px solid transparent;background:#8b5cf6;cursor:pointer;"></button>
                            <button type="button" class="task-color-option" data-color="#ec4899" style="width:28px;height:28px;border-radius:50%;border:2px solid transparent;background:#ec4899;cursor:pointer;"></button>
                            <button type="button" class="task-color-option" data-color="#14b8a6" style="width:28px;height:28px;border-radius:50%;border:2px solid transparent;background:#14b8a6;cursor:pointer;"></button>
                            <button type="button" class="task-color-option" data-color="#f97316" style="width:28px;height:28px;border-radius:50%;border:2px solid transparent;background:#f97316;cursor:pointer;"></button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary btn-sm" id="addTaskBtn" style="width:100%;">追加</button>
                </div>
                <div class="modal-actions" style="margin-top:16px;">
                    <button type="button" class="btn btn-secondary" id="taskModalCancelBtn">閉じる</button>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js" charset="UTF-8"></script>
</body>

</html>